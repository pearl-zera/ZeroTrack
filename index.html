<!DOCTYPE html>
<html>
<head>
<title>Login to ZeroTrack</title>

<!-- Sweet Alert -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="./lib/sweetalert.min.js"></script>
<link rel="stylesheet" type="text/css" href="./lib/sweetalert.css" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');

    body {
        font-family: "Montserrat", sans-serif;
        text-align: center;
        background: #e0f2f7;
        background-image: url('./assets/images/bg.gif');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
    }

    h1 {
        font-size: 50px;
        margin-top: 0;
        color: #1e3a24;
        font-weight: 700;
    }

    .box {
        background: rgba(255, 255, 255, 0.9);
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    input {
        padding: 15px;
        margin-bottom: 20px; 
        width: calc(100% - 30px);
        font-size: 15px;
        border: 1px solid #c8e6c9;
        border-radius: 8px;
        color: #3f5847;
        box-sizing: border-box;
        transition: all 0.3s ease;
    }
    input:focus {
        outline: none;
        border-color: #5cb85c;
        box-shadow: 0 0 8px rgba(92, 184, 92, 0.3);
        }

    button {
        padding: 15px 30px;
        margin-top: 10px;
        background: #80cf84;
        border: none; 
        color: white; 
        border-radius: 8px;
        font-size: 20px; 
        font-weight: 600; 
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
        width: 100%;
    }
    button:hover {
        background: #45a049;
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }
    button:disabled {
        background: #947745;
        color: #cecdcd;
        cursor: auto;
        transform: none;
        box-shadow: none;
    }

    a {
        display: block;
        margin-top: 25px;
        color: #558b2f;
        text-decoration: none;
        transition: color 0.3s ease;
    }
    a:hover {
        text-decoration: underline;
        color: #33691e;
    }

    c {
        display: block;
        margin-top: 15px;
        font-size: 13px;
        color: #FFA000;
        text-decoration: none;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    c:hover {
        text-decoration: underline;
        color: #FF8F00;
    }
    img {
        margin-top: 0;
        margin-bottom: 25px;
        width: 350px;   
        height: auto;
        cursor:pointer;
    }
</style>

</head>
<body>
    <img src="./assets/images/logo.png" id="logo" alt="Logo">
    <div class="box">
    <h1>LOGIN</h1>

    <input type="email" id="email" placeholder="Enter Email"><br>
    <input type="password" id="password" placeholder="Enter Password"><br>

    <button onclick="login()" id="loginButton">Login</button>
    <div id="reset"></div>

    <a href="#" onclick="signup()">Don't have an account? Sign up here.</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyDq_cQj5vTVHFgKnJ6OE7UwPPfDIqpy_gk",
        authDomain: "zero-track.firebaseapp.com",
        databaseURL: "https://zero-track-default-rtdb.firebaseio.com",
        projectId: "zero-track",
        storageBucket: "zero-track.firebasestorage.app",
        messagingSenderId: "278544348006",
        appId: "1:278544348006:web:e62fa713792141e9920ea7",
        measurementId: "G-YLT6JB578D"
    };
    firebase.initializeApp(firebaseConfig);

    var auth = firebase.auth();
    var database = firebase.database();

    document.getElementById("logo").addEventListener("click", () => {
        swal({
            title: "ABOUT",
            text: `ZeroTrack is a sustainability web app that helps you:
                • Log your daily waste Production
                • Track consumption and see your progress
                • Discover eco-friendly tips and alternatives
                \nAligned with\nSDG 12: Responsible Consumption & Production`,
            imageUrl: "./assets/images/logo.png",
            imageSize: "300x75",
            confirmButtonText: "Got it!"
        });
        });

    var fail = 0;

    function login() {

        var email = document.getElementById("email").value.trim();
        var password = document.getElementById("password").value;
        var loginButton = document.getElementById('loginButton');

        if (email === "" || password === "") {
            swal("Error", "Please enter both email and password.", "error");
            return;
        }

        loginButton.disabled = true;
        loginButton.textContent = 'Logging in...';

        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                if (!userCredential.user.emailVerified) {
                    swal({
                        title: "Email Not Verified",
                        text: "Please verify your email before logging in. Would you like us to resend the verification email?",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Resend Email",
                        cancelButtonText: "Cancel"
                    }, function(isConfirm) {
                        if (isConfirm) {
                            userCredential.user.sendEmailVerification()
                                .then(() => {
                                    swal("Verification Email Sent", "We've resent the verification email again. Please check your inbox/spam.", "success");
                                })
                                .catch((error) => {
                                    swal("Error", "Could not resend email: " + error.message, "error");
                                });
                        }
                    });

                    auth.signOut();
                    loginButton.disabled = false;
                    loginButton.textContent = 'Login';
                    return;
                }
                swal("Login successful!", "Welcome!", "success");
                fail = 0;
                setTimeout(() => {
                    window.location.replace("zerotrack.html");
                }, 2000);
            })
            .catch((error) => {
                console.log(error);

                loginButton.disabled = false;
                loginButton.textContent = 'Login';

                if (error.code === "auth/wrong-password") {
                    fail += 1;
                    swal("Wrong Password", "Incorrect password. Please try again.", "error");
                    if (fail > 2) {
                        swal({
                            title: "Login Failed Repeatedly",
                            text: "It seems you're having trouble logging in. Would you like to reset your password?",
                            type: "warning",
                            showCancelButton: true,
                            closeOnConfirm: false,
                            confirmButtonText: "Yes, Reset Password",
                            cancelButtonText: "No, Try Again"
                        }, function(isConfirm) {
                            if (isConfirm) {
                                showResetPassword();
                            }
                        });
                        document.getElementById("reset").innerHTML =
                            '<c onclick="showResetPassword()">Forgot your password? Reset here.</c>';
                    }
                } else if (error.code == "auth/invalid-email") {
                    swal("Error", "Please enter a valid email address.", "error");
                } else if (error.code == "auth/user-not-found") {
                    swal("Account Not Found", "No account found with this email address.", "error");
                } else if (error.code == "auth/too-many-requests") {
                    swal("Account Locked", "Due to repeated failed attempts, this account is currently locked on this device. \n Please try again after a while.", "info");
                } else {
                    swal("Error", error.message, "error");
                }
            });
    }

    function showResetPassword() {
        swal({
            title: "Reset Password",
            text: "Enter the email address associated with your account below:",
            type: "input",
            inputType: "email",
            showCancelButton: true,
            closeOnConfirm: false
        }, function(email) {
            if (email === false || email === "") {
                swal.close()
                return;
            }
            auth.sendPasswordResetEmail(email.trim())
                .then(() => {
                    swal("Reset email sent!", "We've sent an email with password reset instructions. Kindly check your inbox/spam.", "success");
                })
                .catch((error) => {
                    if (error.code === "auth/invalid-email") {
                        swal("Error", "Please enter a valid email address.", "error");
                    } else if (error.code === "auth/user-not-found") {
                        swal("Error", "No account registered with this email address.", "error");
                    } else {
                        swal("Error", error.message, "error");
                    }
                });
        });
    }

    function signup() {
        window.location.replace("signup.html");
    }
    </script>
</body>
</html>
